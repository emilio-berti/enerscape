---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# enerscape

<!-- badges: start -->
<!-- badges: end -->

The goal of enerscape is to ...

## Installation

You can install the released version of enerscape from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("enerscape")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("emilio-berti/enerscape")
```
## Example

This is a basic example which shows you how to solve a common problem:

```{r simple example}
library(enerscape)
library(terra)

#dem <- rast("../data/dem-abruzzi.tif")
#plot(dem)
#en <- enerscape(dem, m = 140, units = "kcal") #typical female Marsican bear
#plot_enerscape(en, what = "work", n_contour = 5)
```

In that case, don't forget to commit and push the resulting figure files, so they display on GitHub!

```{r gradient and lcp}
library(gdistance)
library(raster)
library(enerscape)
dem <- aggregate(dem, 10) #just for speed
p <- dismo::randomPoints(dem, 2)
plot(dem)
points(p, pch = 20, col = c("darkred", "black"))
or <- data.frame(x = p[1, 1], y = p[1, 2])
dest <- data.frame(x = p[2, 1], y = p[2, 2])
slope <- dem_to_slope(dem)
grad <- gradient(dem, or, dest)
plot(grad, col = c(adjustcolor("white", alpha.f = 0),
                   adjustcolor("blue", alpha.f = 0.2)),
     add = TRUE)

w <- calc_work(slope, 140, work_in_kcal = TRUE)
s <- calc_work(slope * grad, 140, work_in_kcal = TRUE)
plot(w)
plot(s)

plot(dem, topo.colors(100))
plot(sign(grad), add = TRUE,
     col = c(adjustcolor("white", alpha.f = 0.0),
             adjustcolor("red", alpha.f = 0.2)))
points(or, pch = 20, col = "blue")
points(dest, pch = 20, col = "black")
cond <- 1 / w
lcp <- transition(cond, function(x) min(x), 16)
shortest_w <- shortestPath(lcp, as.numeric(or), as.numeric(dest), output = "SpatialLines")
lines(shortest_w, lt = 2)
cond <- 1 / s
lcp <- transition(cond, function(x) min(x), 16)
shortest_s <- shortestPath(lcp, as.numeric(or), as.numeric(dest), output = "SpatialLines")
lines(shortest_s)

par(mfrow = c(1, 2))
plot(trim(crop(w, shortest_w)))
lines(shortest_w, lt = 2)
lines(shortest_s)
plot(trim(crop(s, shortest_w)))
plot(trim(crop(grad, shortest_w)), col = c(adjustcolor("white", alpha.f = 0),
                   adjustcolor("blue", alpha.f = 0.2)),
     add = TRUE, legend = FALSE)
lines(shortest_w, lt = 2)
lines(shortest_s)
par(mfrow = c(1, 1))

```

```{r case study 1}
library(enerscape)
library(raster)
library(gdistance)

#s <- readRDS("../data/stack3D.rds")
#p <- data.frame(x = c(863047, 872700), y = c(4667429, 4693600))
#origin <- p[1, ]
#destination <- p[2, ]
#conduct <- 1 / s$work
#shortest <- list()
#lcp <- transition(conduct, function(x) min(x), 16)
#shortest <- shortestPath(lcp, 
#                         as.numeric(origin),
#                         as.numeric(destination), 
#                         output = "SpatialLines")
# least cost path
#plot(s$dem.abruzzi)
#lines(shortest)
#points(p, pch = 20)
# circuitscape cumulative current
#conn <- raster("../data/cs_cum_curmap.asc")
#plot(log10(conn), col = heat.colors(100), 
#     main = expression("log"[10]*"(connectivity)"))
#points(p, pch = 20, col = "steelblue")
#contour(s$dem.abruzzi, add = TRUE)
```

Here, we derive the energy landscape and then remove presence point of a species outside the 95% quantile to mask the habitat suitability.

```{r example 3}
library(enerscape)
library(raster)

# data
set.seed(123456789)
#dem <- raster("../data/dem-abruzzi.tif")
#ext <- Polygon(extent(dem))
#p <- spsample(ext, 25, "random")
#plot(dem)
#points(p)
# get energy landscape
#en <- enerscape(dem, m = 140, units = "kcal")
# mask threshold
#w_val <- extract(en$work, p)
#w_mask <- en$work
#w_mask[w_mask <= quantile(w_val, 0.95)] <- NA
#w_mask[!is.na(w_mask)] <- 1
#plot(dem)
#plot(w_mask, add = TRUE, col = rgb(0.2, 0.2, 0.8, 0.5), legend = FALSE)
```
where the blue areas show the energetically unsuitable cells.
